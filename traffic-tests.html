<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    .test {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .test.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .test.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .summary {
      font-weight: bold;
      margin: 20px 0;
    }

    .log {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <h1>üö¶ –¢–µ—Å—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤ –¥–ª—è –º–∞—à–∏–Ω—ã –®–∏–Ω—ã</h1>
  <div id="results"></div>

  <script type="module">
    import { CarTrafficController } from './carTrafficControl.js';
    import { Direction } from './trafficLights.js';

    const results = document.getElementById('results');
    let passCount = 0;
    let failCount = 0;
    let logs = [];

    function log (message) {
      logs.push(message);
      console.log(message);
    }

    function test (name, testFn) {
      try {
        const result = testFn();
        if (result) {
          results.innerHTML += `<div class="test pass">‚úÖ ${name}</div>`;
          passCount++;
        } else {
          results.innerHTML += `<div class="test fail">‚ùå ${name}</div>`;
          failCount++;
        }
      } catch (error) {
        results.innerHTML += `<div class="test fail">‚ùå ${name} - –û–®–ò–ë–ö–ê: ${error.message}</div>`;
        failCount++;
        log(`Test "${name}" error: ${error.message}`);
      }
    }

    function assertEquals (actual, expected, message = '') {
      if (actual !== expected) {
        throw new Error(`${message} Expected: ${expected}, Actual: ${actual}`);
      }
      return true;
    }

    function assertTrue (condition, message = '') {
      if (!condition) {
        throw new Error(`${message} Expected: true, Actual: false`);
      }
      return true;
    }

    // –ú–æ–∫–∞–µ–º —Å–≤–µ—Ç–æ—Ñ–æ—Ä
    function createMockTrafficLight (phase) {
      return {
        phase: phase,
        isPassAllowed: function (direction) {
          if (direction === Direction.NS) return this.phase.startsWith('NS_');
          if (direction === Direction.EW) return this.phase.startsWith('EW_');
          return true;
        }
      };
    }

    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    const verticalRoadXs = [150, 600, 1050, 1500, 1950, 2400, 2850];
    const horizontalRoadYs = [150, 717, 1283, 1850];
    const roadPositions = { verticalRoadXs, horizontalRoadYs };

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    log('=== –ù–ê–ß–ê–õ–û –¢–ï–°–¢–û–í ===');

    // –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
    test('–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫', () => {
      const controller = new CarTrafficController();
      assertTrue(controller instanceof CarTrafficController);
      assertEquals(controller.isWaiting(), false, '–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å');
      return true;
    });

    // –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è
    test('–ü–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 500, y: 1283 };
      const targetPos = { x: 700, y: 1283 };

      const intersection = controller.findNextIntersection(carPos, targetPos, verticalRoadXs, horizontalRoadYs);

      assertTrue(intersection !== null, '–î–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫');
      assertEquals(intersection.x, 600, 'X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      assertEquals(intersection.y, 1283, 'Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      return true;
    });

    // –¢–µ—Å—Ç 3: –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)
    test('–ü–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 600, y: 500 };
      const targetPos = { x: 600, y: 800 };

      const intersection = controller.findNextIntersection(carPos, targetPos, verticalRoadXs, horizontalRoadYs);

      assertTrue(intersection !== null, '–î–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫');
      assertEquals(intersection.x, 600, 'X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      assertEquals(intersection.y, 717, 'Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      return true;
    });

    // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–ª–µ–Ω–æ–≥–æ —Å–≤–µ—Ç–∞
    test('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–ª–µ–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ - –º–∞—à–∏–Ω–∞ –º–æ–∂–µ—Ç –µ—Ö–∞—Ç—å', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 580, y: 1283 };
      const targetIntersection = { x: 600, y: 1283 }; // –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤ —Å –∑–µ–ª–µ–Ω—ã–º —Å–≤–µ—Ç–æ–º –¥–ª—è EW –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const intersectionMap = new Map();
      intersectionMap.set('600,1283', createMockTrafficLight('EW_GREEN'));

      const result = controller.checkTrafficLights(carPos, targetIntersection, intersectionMap, roadPositions);

      assertTrue(result.canMove, '–î–æ–ª–∂–Ω–∞ –º–æ—á—å –µ—Ö–∞—Ç—å –Ω–∞ –∑–µ–ª–µ–Ω—ã–π');
      assertEquals(result.shouldStop, false, '–ù–µ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è');
      return true;
    });

    // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ —Å–≤–µ—Ç–∞
    test('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ - –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 550, y: 1283 }; // –¥–∞–ª—å—à–µ –æ—Ç –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞
      const targetIntersection = { x: 600, y: 1283 }; // –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤ —Å –∫—Ä–∞—Å–Ω—ã–º —Å–≤–µ—Ç–æ–º –¥–ª—è EW –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∑–µ–ª–µ–Ω—ã–π –¥–ª—è NS)
      const intersectionMap = new Map();
      intersectionMap.set('600,1283', createMockTrafficLight('NS_GREEN'));

      const result = controller.checkTrafficLights(carPos, targetIntersection, intersectionMap, roadPositions);

      assertEquals(result.canMove, false, '–ù–µ –¥–æ–ª–∂–Ω–∞ –º–æ—á—å –µ—Ö–∞—Ç—å –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π');
      assertTrue(result.shouldStop, '–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è');
      assertTrue(result.stopPosition !== undefined, '–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∏—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
      return true;
    });

    // –¢–µ—Å—Ç 6: –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    test('–†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–æ–º', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 500, y: 1283 };
      const intersection = { x: 600, y: 1283 };

      const stopPos = controller.calculateStopPosition(carPos, intersection, Direction.EW);

      assertTrue(stopPos.x < intersection.x, '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      assertEquals(stopPos.y, intersection.y, 'Y –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥–æ—Ä–æ–≥–æ–π');
      assertEquals(stopPos.x, 565, '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 35 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞');
      return true;
    });

    // –¢–µ—Å—Ç 9: –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–æ–≤
    test('–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–æ–≤ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 500, y: 1283 };
      const targetPos = { x: 700, y: 1283 }; // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ

      const intersection = controller.findNextIntersection(carPos, targetPos, verticalRoadXs, horizontalRoadYs);

      assertTrue(intersection !== null, '–î–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫');
      assertEquals(intersection.x, 600, '–ë–ª–∏–∂–∞–π—à–∏–π –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫ –ø–æ X');
      assertEquals(intersection.y, 1283, '–¢–æ—Ç –∂–µ Y (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –¥–æ—Ä–æ–≥–∞)');
      return true;
    });

    // –¢–µ—Å—Ç 7: –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è
    test('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –æ–∂–∏–¥–∞–Ω–∏—è', () => {
      const controller = new CarTrafficController();
      const stopPos = { x: 580, y: 1283 };

      // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –∂–¥–µ—Ç
      assertEquals(controller.isWaiting(), false, '–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –∂–¥–µ—Ç');

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ
      controller.setWaitingState(stopPos, '600,1283');
      assertEquals(controller.isWaiting(), true, '–î–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏');

      const waitPos = controller.getWaitingPosition();
      assertEquals(waitPos.x, stopPos.x, 'X –ø–æ–∑–∏—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è');
      assertEquals(waitPos.y, stopPos.y, 'Y –ø–æ–∑–∏—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è');

      // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      controller.clearWaitingState();
      assertEquals(controller.isWaiting(), false, '–ù–µ –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏');
      return true;
    });

    // –¢–µ—Å—Ç 8: –ù–µ—Ç –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥–∏
    test('–ù–µ—Ç –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥–∏ - —Å–≤–æ–±–æ–¥–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ', () => {
      const controller = new CarTrafficController();
      const carPos = { x: 300, y: 400 }; // –º–µ–∂–¥—É –¥–æ—Ä–æ–≥–∞–º–∏
      const targetPos = { x: 350, y: 400 };

      const intersection = controller.findNextIntersection(carPos, targetPos, verticalRoadXs, horizontalRoadYs);

      assertEquals(intersection, null, '–ù–µ –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫');
      return true;
    });

    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç—ã
    setTimeout(() => {
      const summary = `<div class="summary">
        üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤: ${passCount} –ø—Ä–æ–π–¥–µ–Ω–æ, ${failCount} –ø—Ä–æ–≤–∞–ª–µ–Ω–æ
        ${failCount === 0 ? 'üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!' : '‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ—Å—Ç–∞—Ö'}
      </div>`;

      const logDiv = `<div class="log">${logs.join('\n')}</div>`;

      results.innerHTML = summary + results.innerHTML + logDiv;

      log('=== –ö–û–ù–ï–¶ –¢–ï–°–¢–û–í ===');
      log(`–ò—Ç–æ–≥–æ: ${passCount} –ø—Ä–æ–π–¥–µ–Ω–æ, ${failCount} –ø—Ä–æ–≤–∞–ª–µ–Ω–æ`);
    }, 100);
  </script>
</body>

</html>
