# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

## üìã –û–±–∑–æ—Ä
–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –¶–µ–ª—å: –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (currentRouteIndex, savedCarState –∏ —Ç.–¥.) –∏–∑ main.js –∏ Game.js –≤ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å StateManager.js. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç "–ï–¥–∏–Ω—ã–π –ò—Å—Ç–æ—á–Ω–∏–∫ –ò—Å—Ç–∏–Ω—ã" (SSoT), —Å–¥–µ–ª–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º, —É–ø—Ä–æ—Å—Ç–∏—Ç –æ—Ç–ª–∞–¥–∫—É –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –ø—Ä–æ–µ–∫—Ç –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏.

## üéØ –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ StateManager (1 —à–∞–≥)

### 1.1 –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å StateManager.js ‚úÖ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å StateManager —Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–≤–æ–π—Å—Ç–≤–∞: `this.currentRouteIndex = 0`, `this.savedCarState = null`, `this.lastStayTimerUpdate = 0`, `this.lastStayTimerDay = 0`
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –°–æ–∑–¥–∞–Ω—ã –ø—Ä–æ—Å—Ç—ã–µ get/set –º–µ—Ç–æ–¥—ã –¥–ª—è —ç—Ç–∏—Ö —Å–≤–æ–π—Å—Ç–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `getCurrentRouteIndex()`, `setCurrentRouteIndex(index)`)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í –∫–ª–∞—Å—Å–µ Game.js –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω StateManager –∏ —Å–æ–∑–¥–∞–Ω –µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ: `this.stateManager = new StateManager()`
- **–§–∞–π–ª—ã**: `src/game/StateManager.js` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª), `src/game/Game.js`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫. –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞, —á–µ—Ä–µ–∑ –æ–±—ä–µ–∫—Ç game, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ `game.stateManager` –∏ –µ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–º —Å–≤–æ–π—Å—Ç–≤–∞–º.

## üéØ –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (3 —à–∞–≥–∞)

### 2.1 –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ currentRouteIndex ‚úÖ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–¥–∞–ª–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `currentRouteIndex` –∏–∑ main.js (–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–º –Ω–µ –±—ã–ª–æ)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í –∫–ª–∞—Å—Å–µ Game.js –Ω–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `currentRouteIndex` –∏ –∑–∞–º–µ–Ω–∏—Ç—å –∏—Ö –Ω–∞ –≤—ã–∑–æ–≤—ã `this.stateManager.getCurrentRouteIndex()` (–¥–ª—è —á—Ç–µ–Ω–∏—è) –∏ `this.stateManager.setCurrentRouteIndex(newIndex)` (–¥–ª—è –∑–∞–ø–∏—Å–∏)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–µ–µ —Å–≤–æ–π—Å—Ç–≤–æ `this.currentRouteIndex` –∏–∑ Game.js –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
- **–§–∞–π–ª—ã**: `src/game/Game.js`, `src/main.js` (–µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –µ—â–µ —Ç–∞–º)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ‚úÖ –ú–∞—à–∏–Ω–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–ª–µ–¥—É–µ—Ç –ø–æ –≤—Å–µ–º—É –º–∞—Ä—à—Ä—É—Ç—É –æ—Ç –¥–æ–º–∞ –¥–æ –±–æ–∫—Å–∞ –∏ –æ–±—Ä–∞—Ç–Ω–æ. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞.

### 2.2 –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ savedCarState ‚úÖ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–¥–∞–ª–µ–Ω–æ —Å–≤–æ–π—Å—Ç–≤–æ `savedCarState` –∏–∑ –∫–ª–∞—Å—Å–∞ Game (–∑–∞–º–µ–Ω–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Game.js –Ω–∞ –≤—ã–∑–æ–≤—ã `this.stateManager.getSavedCarState()` –∏ `this.stateManager.setSavedCarState(state)`
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä—É—é—â–µ–µ —Å–≤–æ–π—Å—Ç–≤–æ `this.savedCarState` –∏–∑ Game.js –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
- **–§–∞–π–ª—ã**: `src/game/Game.js`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ‚úÖ –ú–∞—à–∏–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –ø—É–Ω–∫—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–µ–∑–¥–∫–∏ –ø–ª–∞–≤–Ω–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### 2.3 –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É stayTimer ‚úÖ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –∏–∑ –º–µ—Ç–æ–¥–∞ `updateStayTimer()` (–≤ Game.js) –≤ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ StateManager.js `updateStayTimer(gameTime, currentStayDuration)`. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—É—é –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `lastStayTimerUpdate` –∏ `lastStayTimerDay` —É–∂–µ –±—ã–ª–∏ –≤ StateManager –≤ –∫–∞—á–µ—Å—Ç–≤–µ private —Å–≤–æ–π—Å—Ç–≤
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–ø—Ä–æ—â–µ–Ω –º–µ—Ç–æ–¥ `updateStayTimer()` –≤ Game.js: –æ–Ω —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ –∏–∑ stateManager –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ carEntity
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ `this.lastStayTimerUpdate` –∏ `this.lastStayTimerDay` –∏–∑ Game.js –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
- **–§–∞–π–ª—ã**: `src/game/Game.js`, `src/game/StateManager.js`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ‚úÖ –¢–∞–π–º–µ—Ä –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –≤ –ª–æ–∫–∞—Ü–∏—è—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∏ –ø—Ä–µ–∂–¥–µ. –ú–∞—à–∏–Ω–∞ –∂–¥–µ—Ç –ø–æ–ª–æ–∂–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏ —É–µ–∑–∂–∞–µ—Ç.

## üéØ –≠—Ç–∞–ø 3: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–µ—è–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (1 —à–∞–≥)

### 3.1 –£–±—Ä–∞—Ç—å window.isGamePaused –∏ –ø–µ—Ä–µ–¥–∞—Ç—å pauseManager –≤ —Å–≤–µ—Ç–æ—Ñ–æ—Ä—ã ‚úÖ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í PauseManager.js —É–¥–∞–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ `window.isGamePaused = ...`
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í trafficLights.js –∏–∑–º–µ–Ω–µ–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ IntersectionTrafficLight, —á—Ç–æ–±—ã –æ–Ω –ø—Ä–∏–Ω–∏–º–∞–ª —ç–∫–∑–µ–º–ø–ª—è—Ä pauseManager
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í IntersectionTrafficLight._onTick –∏–∑–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (window.isGamePaused)` –Ω–∞ `if (this.pauseManager.isPaused())`
- ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û**: –í Game.js, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤ (–≤–Ω—É—Ç—Ä–∏ createTrafficLightsForAllIntersections), –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `this.pauseManager` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- **–§–∞–π–ª—ã**: `src/game/PauseManager.js`, `src/systems/trafficLights.js`, `src/game/Game.js`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã, —Å–≤–µ—Ç–æ—Ñ–æ—Ä—ã –¥–æ–ª–∂–Ω—ã "–∑–∞–º–∏—Ä–∞—Ç—å" –∏ –ø—Ä–µ–∫—Ä–∞—â–∞—Ç—å —Å–º–µ–Ω—É —Ñ–∞–∑. –ü—Ä–∏ —Å–Ω—è—Ç–∏–∏ —Å –ø–∞—É–∑—ã ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å.

## üéØ –≠—Ç–∞–ø 4: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è (1 —à–∞–≥)

### 4.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ ‚è≥ (–ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø)
- ‚è≥ **–ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø**: –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å Game.js –∏ main.js –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è "–±–µ–∑–¥–æ–º–Ω—ã—Ö" –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚è≥ **–ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–≥—Ä—ã (—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫—É–¥–∞ –µ–¥–µ–º, —Å–∫–æ–ª—å–∫–æ –∂–¥–µ–º) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ stateManager –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ö–æ–¥ —Å—Ç–∞–ª —á–∏—â–µ, –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ.

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö —ç—Ç–∞–ø–æ–≤
- **–≠—Ç–∞–ø 1**: 1 –∑–∞–¥–∞—á–∞ - ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û
- **–≠—Ç–∞–ø 2**: 3 –∑–∞–¥–∞—á–∏ - ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (3/3)  
- **–≠—Ç–∞–ø 3**: 1 –∑–∞–¥–∞—á–∞ - ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (1/1) üéâ
- **–≠—Ç–∞–ø 4**: 1 –∑–∞–¥–∞—á–∞ - –ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø ‚è≥
- **–í—Å–µ–≥–æ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö**: 6 –∑–∞–¥–∞—á, 5 –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: `refactoring-completed-stages.md`
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: `tech-debt.md`
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞: `final-architecture.md`
