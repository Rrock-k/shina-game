# Размышления об архитектуре игры

## Основные сущности
- **Шина** — персонаж, которого пытаются вытащить его друзья.
- **Друзья** — игроки, пытающиеся поймать Шину и позвать гулять.
- **Локации**: дом Шины, дом родителей, работа, секция бокса, дороги и светофоры.
- **Транспорт**: автомобиль, который перемещает Шину между локациями.
- **Средства связи**: звонок и СМС.

## Модель времени
Игра строится на дискретном времени: симуляция продвигается тиками, в каждом из которых обновляется состояние мира. Шина перемещается между локациями по расписанию, а игроки стараются поймать момент, когда он доступен.

## Состояния и ограничения
Каждая локация задаёт условия, при которых Шину нельзя поймать. Например, пока Алина бодрствует, дом блокирует попытки друзей. Эти правила можно описать через "модификаторы доступности", которые применяются к состоянию персонажа. Модификаторы могут быть постоянными (дом родителей) или временными (светофор, на котором Шина стоит несколько тиков).

## Локации как граф
Все локации удобно представить в виде графа: узлы — места, рёбра — дороги между ними. Веса рёбер определяют время перемещения. Такой подход позволит в будущем добавлять альтернативные маршруты и учитывать пробки.

## Движок симуляции
В центре игры находится цикл событий, который учитывает дни недели и стандартное расписание Шины.
1. Обновляет положение Шины и применяет эффекты локаций.
2. Обрабатывает входящие события от друзей (звонки, СМС).
3. Следит за временем сна и активностью персонажа.
4. Продвигает внутренние таймеры и кулдауны.

Реализация может использовать очередь с приоритетами, где ближайшие события обрабатываются первыми. Это упрощает моделирование и позволяет легко ускорять или замедлять игру.

## Модификаторы доступности
Каждая локация или событие добавляет в список активных модификаторов объект, описывающий причину недоступности. Например, `WifeAwake`, `AtParents`, `AtWork`. При проверке доступности движок проходит по списку и объединяет их логику. Такой механизм проще тестировать и расширять.

## Система сообщений
Звонок и СМС — два типа событий. Звонок сразу проверяет занятость Шины и при неудаче вводит долгий кулдаун. СМС попадает в очередь сообщений; когда Шина освобождается, он может ответить или забыть, что задаётся вероятностью. Для реализации подойдёт отдельный модуль `Messaging`, который хранит историю сообщений и отвечает за кулдауны.

### Вероятность ответа
Для каждой СМС задаётся вероятность, что Шина её увидит, когда освободится.

## Игровой интерфейс
Первоначально реализуется текстовый интерфейс, через который друзья будут посылать сообщения. Он отделяется от движка через слой `Controller`, что позволит позже сделать графический клиент.

## Сохранение и конфигурация
Все параметры — длительность поездок, расписание, вероятность ответа — удобно хранить в конфигурационных файлах (JSON/YAML). Движок при старте загружает их, что облегчает балансировку без перекомпиляции кода. Для сохранения прогресса можно сериализовать текущее состояние движка.

## Тестирование
Ключевые компоненты (стейт‑машина Шины, обработка модификаторов, очередь событий) должны покрываться юнит‑тестами. Можно использовать фиктивное время, чтобы проверять переходы состояний без ожидания реального времени.

## Расширяемость
Такой подход позволяет легко добавлять новые локации, правила доступности или виды взаимодействий, не ломая существующую логику. Благодаря модульности можно развивать игру в сторону мультиплеера, добавляя нескольких персонажей с разными расписаниями и взаимоотношениями.

## Логирование и аналитика
Для отладки и анализа поведения полезно вести журнал всех событий: перемещения, входящие сообщения, изменения модификаторов. Эти данные помогут балансировать игру и находить баги.

## Сетевые возможности
Архитектура должна предусматривать возможность вынести симуляцию на сервер и подключать клиентов по сети.
В этом случае движок становится частью серверного приложения, а клиенты получают обновления через WebSocket или другой протокол.
