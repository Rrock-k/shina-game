Конечно. Я полностью обновил `final-architecture.md`, удалив всю историческую информацию о рефакторинге и сфокусировавшись на целевой архитектуре, которая будет реализована.

Документ стал значительно короче, яснее и полностью отражает наши новые планы, включая систему состояний, динамическое расписание и новые игровые механики. Он готов для передачи команде разработчиков.

***

# **Целевая архитектура проекта "Карта Шины"**

## **1. Ключевые принципы**

*   **Разделение ответственности (SoC)**: Каждый модуль выполняет одну, четко определенную задачу. Логика, рендеринг и данные строго изолированы.
*   **Управляемость данными (Data-Driven)**: Поведение игры (расписания, баланс, приоритеты) управляется через конфигурационные файлы (`gameConfig.js`), а не жестко кодируется.
*   **Событийно-ориентированная логика (Event-Driven)**: Системы взаимодействуют через события (например, `новый день`, `получено сообщение`, `задача завершена`), а не через прямые вызовы, что снижает связанность.
*   **Паттерн "Модель-Представление" (Model-View)**: `entities/` (модели) содержат только данные и логику. `rendering/` (представления) отвечают исключительно за отрисовку.

## **2. Структура проекта**

```
src/
├── config/
│   └── gameConfig.js              # Вся конфигурация: баланс, локации, приоритеты
├── game/
│   ├── Game.js                    # Главный класс, оркестратор систем
│   ├── TimeManager.js             # Управление игровым временем
│   ├── ScheduleManager.js         # Генерация и управление задачами (Task) Шины
│   ├── CommunicationManager.js    # Симуляция звонков и СМС от друзей
│   └── DecisionEngine.js          # Логика принятия решений о встрече
├── entities/
│   ├── Shina.js                   # Персонаж (State Machine, система приоритетов)
│   ├── Car.js                     # Логика машины
│   ├── Task.js                    # Сущность для любого дела в расписании
│   └── states/                    # Поведенческие состояния для Шины (State Pattern)
│       ├── IdleState.js
│       ├── SleepingState.js
│       └── ...
├── rendering/
│   ├── WorldRenderer.js           # Отрисовка карты и всех зон
│   ├── CarRenderer.js             # Отрисовка машины
│   └── ...                        # Другие рендереры
├── systems/
│   ├── trafficLights.js           # Существующая система светофоров
│   ├── carTrafficControl.js       # Существующая система управления движением
│   └── panning.js                 # Существующая система панорамирования
├── utils/
│   ├── geometry.js                # Геометрические расчеты
│   └── ...                        # Другие утилиты
└── main.js                        # Точка входа в приложение (инициализация Game.js)
```

## **3. Описание ключевых модулей**

### **`config/gameConfig.js`**
Центральный хаб для всех настраиваемых параметров. Содержит координаты локаций, цвета, а также критически важные для геймдизайна объекты `BALANCING` (шансы, кулдауны, скорость роста приоритетов) и `TASK_PRIORITIES` (базовые приоритеты для всех видов деятельности).

---
### **`game/` (Игровая логика)**

*   **`Game.js`**: "Дирижер" игры. Инициализирует все системы и менеджеры, управляет главным игровым циклом (`update`), передавая управление соответствующим модулям.
*   **`ScheduleManager.js`**: "Личный ассистент" Шины. Генерирует ежедневные расписания, состоящие из объектов `Task`. Предоставляет ключевой метод `addTask()`, позволяющий динамически вставлять в расписание новые события, например, встречу с друзьями.
*   **`CommunicationManager.js`**: Эмулирует внешний мир. Отвечает за симуляцию входящих звонков и СМС в соответствии с правилами из `gameConfig.js`. Не содержит логики, просто передает "сырые" события в `Game.js`.
*   **`DecisionEngine.js`**: "Мозг" Шины. Получает информацию о приглашениях от друзей, анализирует текущее расписание в `ScheduleManager` на наличие свободных "окон", сравнивает динамический приоритет встречи с приоритетами запланированных задач и принимает решение: согласиться и, возможно, отменить другое дело.

---
### **`entities/` (Игровые сущности)**

*   **`Shina.js`**: Центральная игровая сущность.
    *   Реализует паттерн **Конечный автомат (State Machine)** для управления своим поведением. Текущее состояние (например, `SleepingState`, `BusyState`) определяет, может ли Шина отвечать на звонки или читать СМС.
    *   Содержит **Систему Приоритетов**: управляет динамическими значениями, такими как `friendshipPriority` ("соскучился") и `fatigueLevel` ("усталость"), которые напрямую влияют на `DecisionEngine`.
*   **`Task.js`**: Простая структура данных, описывающая любую активность в расписании: от "Сна" до "Встречи в Редбери". Содержит время начала и конца, локацию, приоритет и флаг `isCancellable`.
*   **`states/`**: Папка с классами состояний (`BaseState`, `IdleState`, `DrivingState` и т.д.). Каждый класс инкапсулирует логику поведения Шины в конкретном состоянии, что делает систему легко расширяемой.
