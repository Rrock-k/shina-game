# Упрощенная архитектура проекта "Карта Шины"

## Обзор рефакторинга

Текущий `main.js` (2179 строк) будет разбит на простые логические модули для улучшения читаемости и поддерживаемости кода.

## Упрощенная структура папок

```
src/
├── config/                        # Конфигурация
│   └── gameConfig.js              # Основная конфигурация игры
├── game/                          # Основная игровая логика
│   ├── Game.js                    # Главный класс игры
│   ├── TimeManager.js             # Управление временем
│   ├── PauseManager.js            # Управление паузой и скоростью
│   ├── DayNightManager.js         # Управление днем/ночью
│   └── StateManager.js            # Система состояний Шины
├── rendering/                     # Рендеринг
│   ├── WorldRenderer.js           # Отрисовка мира
│   ├── CarRenderer.js             # Отрисовка машины
│   └── UIRenderer.js              # Отрисовка UI
├── entities/                      # Игровые объекты
│   ├── Car.js                     # Машина
│   ├── TrafficLight.js            # Светофор
│   └── Shina.js                   # Персонаж Шина с состояниями
├── systems/                       # Системы (уже существуют)
│   ├── trafficLights.js           # СУЩЕСТВУЕТ - система светофоров
│   ├── carTrafficControl.js       # СУЩЕСТВУЕТ - контроль движения
│   └── panning.js                 # СУЩЕСТВУЕТ - панорамирование
├── utils/                         # Утилиты
│   ├── geometry.js                # Геометрические функции
│   ├── math.js                    # Математические утилиты
│   └── storage.js                 # Работа с localStorage
└── main.js                        # Точка входа (упрощенная)
```

## Детальное описание модулей

### config/

#### gameConfig.js
- Весь CONFIG объект из main.js
- Константы цветов, размеров, маршрутов
- Настройки зон и светофоров

### game/

#### Game.js
- Главный класс игры
- Инициализация PIXI приложения
- Основной игровой цикл
- Координация всех систем

#### TimeManager.js
- Управление игровым временем (gameTime)
- Форматирование дат и времени
- Обновление времени в реальном времени

#### PauseManager.js
- Управление паузой игры
- Управление скоростью симуляции
- Сохранение/загрузка настроек

#### DayNightManager.js
- Переключение режимов дня/ночи
- Управление освещением
- Цветовые фильтры

#### StateManager.js
- Управление состояниями Шины
- Модификаторы доступности
- Логика "поимки" персонажа

### rendering/

#### WorldRenderer.js
- Отрисовка сетки, дорог, зон, лотов
- Создание перекрестков
- Управление слоями PIXI

#### CarRenderer.js
- Отрисовка машины
- Анимация поворотов
- Обновление позиции

#### UIRenderer.js
- Отрисовка UI элементов
- Меню, уведомления, дисплеи
- Обработка событий UI

### entities/

#### Car.js
- Класс машины
- Физика движения
- Логика маршрутизации
- Интеграция со светофорами

#### TrafficLight.js
- Класс светофора
- Логика переключения
- Визуальное представление

#### Shina.js
- Класс персонажа Шина
- Состояния доступности
- Логика взаимодействия с друзьями

### systems/

#### trafficLights.js (СУЩЕСТВУЕТ)
- Система светофоров на перекрестках
- Координатор "зеленой волны"
- Управление фазами светофоров

#### carTrafficControl.js (СУЩЕСТВУЕТ)
- Контроль движения машины
- Проверка светофоров
- Расчет позиций остановки

#### panning.js (СУЩЕСТВУЕТ)
- Панорамирование карты
- Масштабирование
- Touch и mouse события

### utils/

#### geometry.js
- Геометрические функции
- Поиск ближайших точек
- Расчеты расстояний
- Построение путей

#### math.js
- Математические утилиты
- Интерполяция
- Случайные числа

#### storage.js
- Работа с localStorage
- Сохранение настроек
- Загрузка конфигурации

## Принципы упрощенной архитектуры

### 1. Минимализм
- Только необходимые модули
- Простая структура папок
- Минимум абстракций

### 2. Понятность
- Четкое разделение по функциональности
- Логичные названия модулей
- Простые зависимости

### 3. Практичность
- Легко начать рефакторинг
- Постепенная миграция
- Сохранение работоспособности

## Преимущества упрощенной архитектуры

### 1. Простота
- Легко понять структуру
- Быстро начать работу
- Минимум сложности

### 2. Гибкость
- Легко добавлять новые модули
- Простое изменение структуры
- Быстрая итерация

### 3. Поддерживаемость
- Код разбит на логические части
- Упрощена навигация
- Легче находить и исправлять баги

## Текущий прогресс рефакторинга

### ✅ Выполнено

#### Этап 0: Анализ существующих модулей ✅
1. ✅ Документировать функциональность `trafficLights.js`
2. ✅ Документировать функциональность `carTrafficControl.js`
3. ✅ Документировать функциональность `panning.js`
4. ✅ Определить зависимости между модулями

#### Этап 1: Создание структуры ✅
1. ✅ Создать папки: `config/`, `game/`, `rendering/`, `entities/`, `systems/`, `utils/`
2. ✅ Переместить существующие модули в `systems/`
3. ✅ Создать базовые файлы новых модулей

#### Этап 2: Извлечение конфигурации ✅
1. ✅ Перенести CONFIG в `config/gameConfig.js`
2. ✅ Обновить импорты в main.js

#### Этап 3: Выделение менеджеров (частично)
1. ✅ Создать `TimeManager.js` - перенести функции времени
2. ✅ Создать `PauseManager.js` - перенести функции паузы
3. ✅ Создать `DayNightManager.js` - перенести функции дня/ночи
4. ✅ **ЗАВЕРШЕНО**: Перенести функции управления паузой из main.js в PauseManager.js
   - Удалены дублирующиеся функции: `saveSpeedSettings()`, `loadSpeedSettings()`, `pauseGame()`, `resumeGame()`, `togglePause()`, `updatePauseButton()`, `updatePauseModeText()`, `showSpeedNotification()`
   - Удалены глобальные переменные: `SPEED_MULTIPLIER`, `isSpeedBoosted`, `isGamePaused`
   - Обновлен код для использования `pauseManager` вместо старых функций
   - main.js стал на ~60 строк короче
5. ✅ **ЗАВЕРШЕНО**: Перенести функции времени из main.js в TimeManager.js
   - Удалены дублирующиеся функции: `getMonthName()`, `getDayOfWeekShort()`, `getDayOfWeek()`, `getDaysInMonth()`, `formatGameDateTime()`
   - Удалены глобальные переменные: `gameTime`, `BASE_TIME_SPEED`, `lastTimeUpdate`
   - Обновлена функция `updateGameTime()` для использования `timeManager.update()`
   - Все функции теперь получают время через `timeManager.getGameTime()`
   - main.js стал еще на ~40 строк короче
6. ✅ **ЗАВЕРШЕНО**: Перенести функции дня/ночи из main.js в DayNightManager.js
   - Удалены дублирующиеся функции-обертки: `loadDayNightSettings()`, `isNightTime()`, `createCityNightOverlay()`, `updateNightMode()`, `toggleDayNightMode()`, `updateDayNightModeText()`
   - Перенесены функции цветовых фильтров: `applyNightColorFilter()`, `resetDayColorFilter()`, `addLightSource()`, `removeLightSource()`
   - Удалены глобальные переменные: `dayNightMode`, `isNightMode`, `cityNightOverlay`, `nightTransitionSpeed`, `currentCityNightAlpha`
   - Обновлен код для использования `dayNightManager` вместо старых функций
   - Исправлена ошибка `ReferenceError: updateNightMode is not defined`
   - main.js стал еще на ~50 строк короче

### 🔄 В процессе

#### Этап 4: Выделение рендеринга (готов к началу)
- ⏳ Создать `WorldRenderer.js` - перенести функции отрисовки мира
- ⏳ Создать `CarRenderer.js` - перенести функции отрисовки машины
- ⏳ Создать `UIRenderer.js` - перенести UI функции

### ⏳ Планируется

#### Этап 5: Выделение сущностей
1. Создать `Car.js` - класс машины
2. Создать `TrafficLight.js` - класс светофора
3. Создать `Shina.js` - класс персонажа с состояниями

#### Этап 6: Утилиты
1. Создать `geometry.js` - геометрические функции
2. Создать `math.js` - математические утилиты
3. Создать `storage.js` - работа с localStorage

#### Этап 7: Рефакторинг main.js
1. Упростить main.js до минимума
2. Использовать импорты модулей
3. Тестирование работоспособности

#### Этап 8: Игровая механика (будущее развитие)
1. Реализовать систему состояний Шины
2. Добавить систему друзей и сообщений
3. Создать UI для игроков-друзей

## План миграции

### Этап 0: Анализ существующих модулей
1. Документировать функциональность `trafficLights.js`
2. Документировать функциональность `carTrafficControl.js`
3. Документировать функциональность `panning.js`
4. Определить зависимости между модулями

### Этап 1: Создание структуры
1. Создать папки: `config/`, `game/`, `rendering/`, `entities/`, `systems/`, `utils/`
2. Переместить существующие модули в `systems/`
3. Создать базовые файлы новых модулей

### Этап 2: Извлечение конфигурации
1. Перенести CONFIG в `config/gameConfig.js`
2. Обновить импорты в main.js

### Этап 3: Выделение менеджеров
1. Создать `TimeManager.js` - перенести функции времени
2. Создать `PauseManager.js` - перенести функции паузы
3. Создать `DayNightManager.js` - перенести функции дня/ночи

### Этап 4: Выделение рендеринга
1. Создать `WorldRenderer.js` - перенести функции отрисовки мира
2. Создать `CarRenderer.js` - перенести функции отрисовки машины
3. Создать `UIRenderer.js` - перенести UI функции

### Этап 5: Выделение сущностей
1. Создать `Car.js` - класс машины
2. Создать `TrafficLight.js` - класс светофора
3. Создать `Shina.js` - класс персонажа с состояниями

### Этап 6: Утилиты
1. Создать `geometry.js` - геометрические функции
2. Создать `math.js` - математические утилиты
3. Создать `storage.js` - работа с localStorage

### Этап 7: Рефакторинг main.js
1. Упростить main.js до минимума
2. Использовать импорты модулей
3. Тестирование работоспособности

### Этап 8: Игровая механика (будущее развитие)
1. Реализовать систему состояний Шины
2. Добавить систему друзей и сообщений
3. Создать UI для игроков-друзей

## Игровая механика (будущее развитие)

### Система состояний Шины
- `available` - доступен для "поимки"
- `atWork` - на работе, недоступен
- `sleeping` - спит, недоступен
- `driving` - едет, недоступен

### Система друзей
- Отправка сообщений (звонки, СМС)
- Проверка доступности Шины
- Система уведомлений

## Производительность

### Текущие показатели
- 60 FPS стабильно
- Память: ~50MB
- Время загрузки: <2 сек

## Заключение

Упрощенная архитектура обеспечивает:
- **Простоту** - легко понять и начать работу
- **Гибкость** - легко изменять и расширять
- **Практичность** - можно начать рефакторинг прямо сейчас
- **Постепенность** - миграция по частям без поломки функциональности

Эта структура идеально подходит для начала рефакторинга и может быть расширена в будущем при необходимости.
