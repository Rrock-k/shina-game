# Структура слоев PIXI.js в игре

## Иерархия слоев (сверху вниз):

```
app.stage
├── uiLayer - UI элементы
├── lightingLayer - Источники света (не используется для светофоров)
└── world
    ├── trafficLightsLayer - Светофоры (ПОВЕРХ затемнения!)
    ├── decorLayer - Машина и декорации (ПОВЕРХ затемнения!)
    ├── cityNightOverlay - Затемнение только для города
    ├── borderLayer - Границы мира
    ├── labelsLayer - Подписи
    ├── zonesLayer - Зоны (дома, работа, институт)
    ├── lotsLayer - Участки земли
    ├── intersectionsLayer - Перекрестки
    ├── roadsLayer - Дороги
    └── gridLayer - Сетка
```

## Ключевые особенности:

1. **cityNightOverlay** - единственный слой затемнения, применяется только к городским элементам
2. **Порядок слоев** - машина (decorLayer) и светофоры (trafficLightsLayer) рендерятся поверх затемнения
3. **Упрощенная архитектура** - убран дублирующий код, оставлен только необходимый функционал
4. **Порядок рендеринга** - контролируется через последовательность `addChild()`, `zIndex` не используется

## Эффект:

- ✅ Город/дома затемняются ночью
- ✅ Машина остается яркой и видимой
- ✅ Светофоры светятся поверх затемнения
- ✅ Плавные переходы между днем и ночью
- ✅ Чистый код без дублирования

## Исправление бага с видимостью (2024-12-19)

**Проблема**: Машина и светофоры не были видны, хотя логика работала.

**Корневая причина**: Неправильный порядок инициализации - машина добавлялась в `decorLayer` ДО того, как сам `decorLayer` был добавлен в `world`.

**Исправления**:
- ✅ `decorLayer` и `trafficLightsLayer` теперь добавляются в `_setupWorld()` в правильном порядке
- ✅ `cityNightOverlay` вставляется между базовыми слоями и слоями с машиной/светофорами через `addChildAt()`
- ✅ Исправлен предупреждение `stayStartTimeAbs` в `checkArrival()`
- ✅ Порядок рендеринга контролируется через последовательность `addChild()`, `zIndex` не используется

**Файлы**: `Game.js`, `DayNightManager.js`
